<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Improver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #334155;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.2s;
        }
        textarea:focus {
            outline: none;
            border-color: #6366f1;
        }
        button {
            background-color: #6366f1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        button:hover {
            background-color: #4f46e5;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        .loading-indicator {
            display: flex; /* Use flexbox for centering spinner and text */
            align-items: center;
            justify-content: center;
            color: #6366f1;
            font-weight: 600;
            margin-top: 1rem;
            gap: 0.5rem; /* Space between spinner and text */
        }
        .output-area {
            background-color: #f8fafc;
            padding: 1.5rem;
            border: 1px dashed #a78bfa;
            border-radius: 0.5rem;
            min-height: 150px;
            white-space: pre-wrap; /* Preserves whitespace and line breaks */
            word-wrap: break-word; /* Breaks long words */
            font-size: 1rem;
            line-height: 1.6;
        }
        .word-count {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.5rem;
            text-align: right;
        }

        /* Spinner CSS */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Novel Post-Editor</h1>
        <p class="text-center text-gray-600 mb-8">
            Paste your machine-translated novel text below. I will help improve its fluency, style, and naturalness.
            Please note that for very long texts, it's best to process them in sections (e.g., chapter by chapter)
            due to API token limits and processing time.
        </p>

        <div class="mb-6">
            <label for="inputText" class="block text-gray-700 text-lg font-semibold mb-2">Machine-Translated Text:</label>
            <textarea id="inputText" placeholder="Paste your novel text here..."></textarea>
            <div id="originalWordCount" class="word-count">Words: 0</div>
        </div>

        <div class="flex justify-center mb-8">
            <button id="improveButton">Improve Novel</button>
        </div>

        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <span>Processing... Please wait.</span>
        </div>

        <div class="mb-6">
            <label for="outputText" class="block text-gray-700 text-lg font-semibold mb-2">Improved Version:</label>
            <div id="outputText" class="output-area">
                Your improved text will appear here.
            </div>
            <div id="improvedWordCount" class="word-count">Words: 0</div>
        </div>

        <div class="flex justify-center">
            <button id="copyButton" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105" style="display: none;">Copy Improved Text</button>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase (will be provided by the Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Elements
        const inputText = document.getElementById('inputText');
        const improveButton = document.getElementById('improveButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const outputText = document.getElementById('outputText');
        const copyButton = document.getElementById('copyButton');
        const originalWordCountDisplay = document.getElementById('originalWordCount');
        const improvedWordCountDisplay = document.getElementById('improvedWordCount');

        // Function to calculate word count
        function calculateWordCount(text) {
            const words = text.trim().split(/\s+/).filter(word => word.length > 0);
            return words.length;
        }

        // Update original word count as user types
        inputText.addEventListener('input', () => {
            const count = calculateWordCount(inputText.value);
            originalWordCountDisplay.textContent = `Words: ${count}`;
        });

        improveButton.addEventListener('click', async () => {
            const novelText = inputText.value.trim();

            if (!novelText) {
                outputText.textContent = "Please paste some text to improve.";
                outputText.style.borderColor = '#ef4444'; // Red border for error
                copyButton.style.display = 'none';
                improvedWordCountDisplay.textContent = 'Words: 0'; // Reset improved word count
                return;
            }

            loadingIndicator.style.display = 'flex'; // Show loading indicator (flex to center spinner)
            improveButton.disabled = true;
            outputText.textContent = ''; // Clear previous output
            outputText.style.borderColor = '#a78bfa'; // Reset border color
            improvedWordCountDisplay.textContent = 'Words: 0'; // Reset improved word count before processing

            try {
                let chatHistory = [];
                // Craft a detailed prompt for novel post-editing
                const prompt = `You are an expert literary editor and translator. Your task is to take the following machine-translated novel text and refine it to sound natural, fluent, and engaging in English. Focus on:
                - Improving sentence structure and flow.
                - Enhancing vocabulary and word choice to match a literary tone.
                - Correcting any awkward phrasing or literal translations.
                - Ensuring consistency in character names and key terms (if any are apparent).
                - Maintaining the original meaning and emotional nuance.
                - Adapting any subtle cultural references to be understandable to an English-speaking audience without losing their essence.
                - Do not add or remove significant plot points or character actions.
                - Do not include any conversational filler or introductions/conclusions in your response; just provide the improved text.

                Here is the machine-translated text:
                "${novelText}"`;

                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        temperature: 0.7, // Adjust temperature for creativity vs. adherence
                        topP: 0.9,
                        topK: 40,
                    }
                };

                const apiKey = "AIzaSyBWqlUopu9LN1OvvnLADSW077QSiWQGfRo"; // Canvas will automatically provide the API key - New key!!
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const improvedText = result.candidates[0].content.parts[0].text;
                    outputText.textContent = improvedText;
                    copyButton.style.display = 'block';
                    improvedWordCountDisplay.textContent = `Words: ${calculateWordCount(improvedText)}`;
                } else {
                    outputText.textContent = "Could not generate improved text. Please try again or refine your input.";
                    outputText.style.borderColor = '#ef4444'; // Red border for error
                    copyButton.style.display = 'none';
                    improvedWordCountDisplay.textContent = 'Words: 0';
                }

            } catch (error) {
                console.error("Error improving novel:", error);
                outputText.textContent = `An error occurred: ${error.message}. Please try again.`;
                outputText.style.borderColor = '#ef4444'; // Red border for error
                copyButton.style.display = 'none';
                improvedWordCountDisplay.textContent = 'Words: 0';
            } finally {
                loadingIndicator.style.display = 'none'; // Hide loading indicator
                improveButton.disabled = false;
            }
        });

        copyButton.addEventListener('click', () => {
            const textToCopy = outputText.textContent;
            if (textToCopy) {
                // Use document.execCommand('copy') for better compatibility in iframes
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                textarea.style.position = 'fixed'; // Prevent scrolling to bottom
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('Text copied to clipboard!'); // Use a simple alert for now, can be replaced with custom modal
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy text. Please copy manually.');
                } finally {
                    document.body.removeChild(textarea);
                }
            }
        });
    </script>
</body>
</html>
